{% extends 'base.html' %}
{% load static %}

{% block title %}Domain Tahlil - SiteScaner{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/scan.css">
{% endblock extra_css %}

{% block content %}
<div class="container">
    <div class="header-section">
        <h1 class="main-title glitch">Domain Tahlil</h1>
        <p class="subtitle">Domainlarni kiritib, xavfsizlik tahlilini boshlang</p>
    </div>

    <div class="scan-container">
        <!-- Domain Input Section -->
        <div class="input-section card">
            {% csrf_token %}
            <h2>Domainlar</h2>
            <div class="form-group">
                <label for="domainsInput">Domain nomlarini kiriting (har qatorda bitta):</label>
                <textarea 
                    id="domainsInput" 
                    class="form-input" 
                    rows="5" 
                    placeholder="example.com&#10;test.com&#10;demo.org"
                >{% if existing_domains %}{{ existing_domains|join:"&#10;" }}{% endif %}</textarea>
            </div>
            <button class="btn btn-primary" onclick="prepareDomains()">Tayyorlash</button>
        </div>

        <!-- Domains List Section -->
        <div class="domains-section card" id="domainsSection" style="display: none;">
            <h2>Tayyorlangan Domainlar</h2>
            <div class="domains-list" id="domainsList">
                <!-- Domains will be populated here -->
            </div>
            <div class="scan-actions">
                <button class="btn btn-success btn-large" onclick="startScan()" id="startScanBtn">Tahlilni boshlash</button>
                <button class="btn btn-danger btn-large" onclick="stopAllScans()" id="stopScanBtn" style="display: none;">‚èπÔ∏è Tahlilni to'xtatish</button>
                <button class="btn btn-secondary" onclick="resetDomains()">Qaytadan boshlash</button>
                <button class="btn btn-primary" onclick="addMoreDomains()">+ Domain qo'shish</button>
            </div>
        </div>

        <!-- Scan Results Section -->
        {% if show_results %}
        <div class="results-section card">
            <h2>Tahlil Natijalari</h2>
            <div class="results-summary">
                <p><strong>Jami tahlil qilingan:</strong> {{ total_scanned }} ta</p>
                <p><strong>Tahlil vaqti:</strong> {{ timestamp|date:"d.m.Y H:i:s" }}</p>
            </div>
            
            <div class="results-list">
                {% for result in scan_results %}
                <div class="result-item card">
                    <div class="result-header">
                        <h3>{{ result.domain }}</h3>
                        <span class="status-badge status-{{ result.status }}">
                            {% if result.status == 'completed' %}
                                ‚úÖ Tugallandi
                            {% elif result.status == 'failed' %}
                                ‚ùå Xatolik
                            {% else %}
                                ‚è≥ Jarayonda
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if result.status == 'completed' %}
                    <div class="result-details">
                        <div class="detail-row">
                            <strong>IP Manzil:</strong> {{ result.ip_address|default:"Topilmadi" }}
                        </div>
                        <div class="detail-row">
                            <strong>SSL:</strong> 
                            {% if result.ssl_info.ssl_enabled %}
                                ‚úÖ Faol
                            {% else %}
                                ‚ùå Faol emas
                            {% endif %}
                        </div>
                        <div class="detail-row">
                            <strong>Xavfsizlik sarlavhalari:</strong>
                            <ul class="security-headers">
                                <li>X-Frame-Options: {{ result.security_headers.x_frame_options }}</li>
                                <li>X-Content-Type-Options: {{ result.security_headers.x_content_type_options }}</li>
                                <li>X-XSS-Protection: {{ result.security_headers.x_xss_protection }}</li>
                                <li>HSTS: {{ result.security_headers.strict_transport_security }}</li>
                                <li>CSP: {{ result.security_headers.content_security_policy }}</li>
                            </ul>
                        </div>
                        
                        <!-- Tool Scanning Results -->
                        {% if result.tool_results %}
                        <div class="tool-results">
                            <h4>üîß Tool Tahlil Natijalari</h4>
                            
                            <!-- Nmap Results -->
                            {% if result.tool_results.nmap %}
                            <div class="tool-result nmap-result">
                                <h5>üåê Nmap (Port & Vulnerability Scan)</h5>
                                {% if result.tool_results.nmap.status == 'completed' %}
                                    {% if result.tool_results.nmap.ports %}
                                    <div class="ports-info">
                                        <strong>Ochiq Portlar:</strong>
                                        <ul>
                                        {% for port in result.tool_results.nmap.ports %}
                                            <li>Port {{ port.port }} ({{ port.service }})</li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                    
                                    {% if result.tool_results.nmap.vulnerabilities %}
                                    <div class="vulnerabilities-info">
                                        <strong>Topilgan Zaifliklar:</strong>
                                        <ul>
                                        {% for vuln in result.tool_results.nmap.vulnerabilities %}
                                            <li>{{ vuln }}</li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <span class="tool-status tool-{{ result.tool_results.nmap.status }}">
                                        {{ result.tool_results.nmap.error|default:"Tahlil tugallanmadi" }}
                                    </span>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- SQLMap Results -->
                            {% if result.tool_results.sqlmap %}
                            <div class="tool-result sqlmap-result">
                                <h5>üíâ SQLMap (SQL Injection Scan)</h5>
                                {% if result.tool_results.sqlmap.status == 'completed' %}
                                    {% if result.tool_results.sqlmap.vulnerabilities %}
                                    <div class="vulnerabilities-info">
                                        <strong>Topilgan SQL Injection:</strong>
                                        <ul>
                                        {% for vuln in result.tool_results.sqlmap.vulnerabilities %}
                                            <li>{{ vuln }}</li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                    {% else %}
                                        <span class="tool-status tool-safe">‚úÖ SQL Injection topilmadi</span>
                                    {% endif %}
                                {% else %}
                                    <span class="tool-status tool-{{ result.tool_results.sqlmap.status }}">
                                        {{ result.tool_results.sqlmap.error|default:"Tahlil tugallanmadi" }}
                                    </span>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- Gobuster Results -->
                            {% if result.tool_results.gobuster %}
                            <div class="tool-result gobuster-result">
                                <h5>üìÅ Gobuster (Directory Discovery)</h5>
                                {% if result.tool_results.gobuster.status == 'completed' %}
                                    {% if result.tool_results.gobuster.directories %}
                                    <div class="directories-info">
                                        <strong>Topilgan Direktoriyalar:</strong>
                                        <ul>
                                        {% for dir in result.tool_results.gobuster.directories %}
                                            <li>{{ dir }}</li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                    {% else %}
                                        <span class="tool-status tool-safe">‚úÖ Maxsus direktoriyalar topilmadi</span>
                                    {% endif %}
                                {% else %}
                                    <span class="tool-status tool-{{ result.tool_results.gobuster.status }}">
                                        {{ result.tool_results.gobuster.error|default:"Tahlil tugallanmadi" }}
                                    </span>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- XSStrike Results -->
                            {% if result.tool_results.xsstrike %}
                            <div class="tool-result xsstrike-result">
                                <h5>üï∑Ô∏è XSStrike (XSS Detection)</h5>
                                {% if result.tool_results.xsstrike.status == 'completed' %}
                                    {% if result.tool_results.xsstrike.xss_vulnerabilities %}
                                    <div class="vulnerabilities-info">
                                        <strong>Topilgan XSS Zaifliklari:</strong>
                                        <ul>
                                        {% for vuln in result.tool_results.xsstrike.xss_vulnerabilities %}
                                            <li>{{ vuln }}</li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                    {% else %}
                                        <span class="tool-status tool-safe">‚úÖ XSS zaifliklari topilmadi</span>
                                    {% endif %}
                                {% else %}
                                    <span class="tool-status tool-{{ result.tool_results.xsstrike.status }}">
                                        {{ result.tool_results.xsstrike.error|default:"Tahlil tugallanmadi" }}
                                    </span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% elif result.status == 'failed' %}
                    <div class="error-message">
                        <strong>Xatolik:</strong> {{ result.error }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="/static/js/scan.js"></script>
{% endblock extra_js %}