{% extends 'base.html' %}

{% block title %}Tahlil Tarixi - SiteScaner{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/scan.css">
{% endblock extra_css %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-title">Tahlil Tarixi</div>
    <div class="page-subtitle">Yangi va eski tahlil qilingan domenlar va natijalar</div>
</div>

<!-- Stats Overview -->
<div class="stats-overview">
    <div class="stats-single">
        <div class="stat-card">
            <div class="stat-content">
                <div class="stat-number">{{ total_count }}</div>
                <div class="stat-label">Jami Tahlillar</div>
            </div>
        </div>
    </div>
    <div class="stats-single">
        <div class="stat-card">
            <div class="stat-content">
                <div class="stat-number">{{ new_count }}</div>
                <div class="stat-label">Bugungi Yangi</div>
            </div>
        </div>
    </div>
</div>

<!-- Scan History Container -->
<div class="scan-container">
    <!-- History Header -->
    <div class="history-header">
        <h2>Tahlil tarixi</h2>
        <a href="{% url 'scan' %}" class="btn btn-primary">Yangi tahlil</a>
    </div>
    
    <!-- Yangi tahlillar (24 soat ichida) -->
    {% if new_scans %}
    <div class="new-scans-section">
        <h3 class="section-title new-title">
            <span class="title-text">ðŸ†• Bugungi yangi tahlillar</span>
            <span class="title-count">{{ new_count }}</span>
        </h3>
        <div class="history-grid new-scans-grid">
            {% for scan in new_scans %}
            <div class="scan-item new-scan-item">
                <div class="scan-item-header">
                    <div class="domain-info-with-icon">
                        <div class="domain-icon">
                            <img src="https://www.google.com/s2/favicons?domain={{ scan.domain_name }}&sz=32" 
                                 alt="{{ scan.domain_name }} icon" 
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMiA3VjIwQzIgMjAuNTUyMyAyLjQ0NzcyIDIxIDMgMjFIMjFDMjEuNTUyMyAyMSAyMiAyMC41NTIzIDIyIDIwVjdMMTIgMloiIHN0cm9rZT0iIiMwMGZmMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik05IDIxVjE0TDE1IDEwVjIxIiBzdHJva2U9IiMwMGZmMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPg=='"
                                 class="favicon">
                        </div>
                        <div class="domain-text">
                            <h3>{{ scan.domain_name }}</h3>
                        </div>
                    </div>
                    <span class="scan-status {{ scan.status }}">{{ scan.get_status_display }}</span>
                </div>
                <div class="scan-item-details">
                    <p><strong>IP:</strong> {{ scan.ip_address|default:"N/A" }}</p>
                    <p><strong>Sana:</strong> {{ scan.scan_date|date:"d.m.Y H:i" }}</p>
                    <p><strong>Davomiyligi:</strong> {{ scan.get_duration }}</p>
                </div>
                {% if scan.status == 'completed' %}
                <div class="scan-item-actions">
                    <button class="btn btn-small" onclick="viewScanDetails({{ scan.id }})">Batafsil</button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Eski tahlillar (24 soatdan oldin) -->
    {% if old_scans %}
    <div class="old-scans-section">
        <h3 class="section-title old-title">
            <span class="title-text">ðŸ“š Barcha tahlillar</span>
            <span class="title-count">{{ old_count }}</span>
        </h3>
        <div class="history-grid old-scans-grid">
            {% for scan in old_scans %}
            <div class="scan-item old-scan-item">
                <div class="scan-item-header">
                    <div class="domain-info-with-icon">
                        <div class="domain-icon">
                            <img src="https://www.google.com/s2/favicons?domain={{ scan.domain_name }}&sz=32" 
                                 alt="{{ scan.domain_name }} icon" 
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMiA3VjIwQzIgMjAuNTUyMyAyLjQ0NzcyIDIxIDMgMjFIMjFDMjEuNTUyMyAyMSAyMiAyMC41NTIzIDIyIDIwVjdMMTIgMloiIHN0cm9rZT0iIiMwMGZmMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik05IDIxVjE0TDE1IDEwVjIxIiBzdHJva2U9IiMwMGZmMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPg=='"
                                 class="favicon">
                        </div>
                        <div class="domain-text">
                            <h3>{{ scan.domain_name }}</h3>
                        </div>
                    </div>
                    <span class="scan-status {{ scan.status }}">{{ scan.get_status_display }}</span>
                </div>
                <div class="scan-item-details">
                    <p><strong>IP:</strong> {{ scan.ip_address|default:"N/A" }}</p>
                    <p><strong>Sana:</strong> {{ scan.scan_date|date:"d.m.Y H:i" }}</p>
                    <p><strong>Davomiyligi:</strong> {{ scan.get_duration }}</p>
                </div>
                {% if scan.status == 'completed' %}
                <div class="scan-item-actions">
                    <button class="btn btn-small" onclick="viewScanDetails({{ scan.id }})">Batafsil</button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Hech qanday tahlil yo'q -->
    {% if not new_scans and not old_scans %}
    <div class="no-scans">
        <p>Hali hech qanday tahlil qilinmagan.</p>
        <a href="{% url 'scan' %}" class="btn btn-primary">Birinchi tahlilni boshlash</a>
    </div>
    {% endif %}
</div>

<!-- Scan Details Modal -->
<div class="modal" id="scanDetailsModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title-section">
                <h3 id="modalTitle">Tahlil tafsilotlari</h3>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Modal content will be populated here -->
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="/static/js/scan_history.js"></script>
{% endblock extra_js %} 